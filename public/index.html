<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Chat + Antidote</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121a33;
      --muted: #a0adcf;
      --text: #e9efff;
      --accent: #5aa2ff;
      --accent-2: #7affc7;
      --danger: #ff6b6b;
      --ok: #72e5a2;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 10% 0%, rgba(90,162,255,.08), transparent),
                  radial-gradient(1200px 600px at 90% 20%, rgba(122,255,199,.08), transparent),
                  var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Color Emoji", "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap {
      max-width: 900px; margin: 0 auto; padding: 16px; display: grid; gap: 12px;
      grid-template-rows: auto 1fr auto;
      height: 100%;
    }
    header, footer, .panel { background: color-mix(in oklab, var(--panel) 85%, black 15%); border: 1px solid #1a2750; border-radius: 12px; }
    header, footer { padding: 10px 12px; }
    header { display: grid; gap: 8px; grid-template-columns: 1fr auto; align-items: center; }
    .status { font-size: 12px; color: var(--muted); }
    .badge { padding: 2px 8px; border-radius: 999px; border: 1px solid #2a3b7a; color: var(--muted); }
    .badge.ok { color: var(--ok); border-color: #2b6a53; }
    .badge.off { color: var(--danger); border-color: #6a2b2b; }
    .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .controls input[type="text"] {
      background: #0e1530; border: 1px solid #1f2e60; color: var(--text);
      padding: 8px 10px; border-radius: 8px; width: 220px;
    }
    .room { background: #0e1530; border: 1px solid #1f2e60; color: var(--text); padding: 8px 10px; border-radius: 8px; }
    .panel { padding: 10px; display: grid; grid-template-rows: 1fr auto; gap: 10px; min-height: 300px; }
    .msgs { overflow: auto; display: flex; flex-direction: column; gap: 8px; padding-right: 4px; }
    .msg {
      background: #0f1732; border: 1px solid #1f2e60; border-radius: 10px; padding: 8px 10px;
      display: grid; gap: 4px;
    }
    .meta { display: flex; align-items: baseline; gap: 8px; }
    .author { font-weight: 600; color: var(--accent-2); }
    .time { font-size: 12px; color: var(--muted); }
    .content { white-space: pre-wrap; line-break: anywhere; }
    .file-link { color: var(--accent); text-decoration: none; }
    .file-link:hover { text-decoration: underline; }
    .composer { display: grid; gap: 8px; grid-template-columns: 1fr auto; align-items: end; }
    textarea {
      background: #0e1530; border: 1px solid #1f2e60; color: var(--text);
      padding: 10px; border-radius: 10px; min-height: 70px; resize: vertical; font-family: inherit;
    }
    .actions { display: flex; gap: 8px; align-items: center; }
    .btn {
      background: linear-gradient(180deg, #3b61ff, #2747c9); color: white; border: none; padding: 10px 14px;
      border-radius: 10px; cursor: pointer; font-weight: 600;
      box-shadow: 0 6px 20px rgba(59,97,255,.25);
    }
    .btn.secondary {
      background: #182452; color: var(--text); border: 1px solid #2a3b7a; box-shadow: none;
    }
    input[type="file"] { display: none; }
    .attach { padding: 9px 12px; border-radius: 10px; background: #182452; border: 1px dashed #2a3b7a; color: var(--text); cursor: pointer; }
    .hint { font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div>Chat + Antidote</div>
        <div class="status">Status da API: <span id="status" class="badge off">offline</span></div>
      </div>
      <div class="controls">
        <input id="author" type="text" placeholder="Seu nome"/>
        <select id="room" class="room">
          <option value="geral" selected>#geral</option>
        </select>
        <button id="refresh" class="btn secondary">Atualizar</button>
      </div>
    </header>

    <section class="panel">
      <div id="msgs" class="msgs"></div>

      <form id="composer" class="composer">
        <div>
          <textarea id="text" placeholder="Escreva sua mensagem. Enter envia • Shift+Enter pula linha"></textarea>
          <div class="hint">Anexos: clique em “Anexar” ou arraste e solte um arquivo aqui.</div>
        </div>
        <div class="actions">
          <input id="file" type="file"/>
          <label for="file" class="attach">Anexar</label>
          <button id="send" class="btn" type="submit">Enviar</button>
        </div>
      </form>
    </section>

    <footer>
      <span class="hint">Dica: o nome fica salvo no navegador. Enter envia, Shift+Enter quebra a linha.</span>
    </footer>
  </div>

  <script>
    const API = location.origin;
    const statusEl = document.getElementById("status");
    const msgsEl = document.getElementById("msgs");
    const authorEl = document.getElementById("author");
    const roomEl = document.getElementById("room");
    const formEl = document.getElementById("composer");
    const textEl = document.getElementById("text");
    const fileEl = document.getElementById("file");
    const refreshBtn = document.getElementById("refresh");

    // Persistência local do nome
    authorEl.value = localStorage.getItem("chat_author") || "";
    authorEl.addEventListener("change", () => {
      localStorage.setItem("chat_author", authorEl.value.trim());
    });

    // Verifica API
    async function checkHealth() {
      try {
        const r = await fetch(API + "/health", { cache: "no-store" });
        statusEl.textContent = r.ok ? "online" : "offline";
        statusEl.className = "badge " + (r.ok ? "ok" : "off");
      } catch {
        statusEl.textContent = "offline";
        statusEl.className = "badge off";
      }
    }

    function fmtTime(ts) {
      const d = new Date(ts);
      return d.toLocaleString("pt-BR", {
        day: "2-digit", month: "2-digit", year: "numeric",
        hour: "2-digit", minute: "2-digit"
      });
    }

    function render(messages) {
      msgsEl.innerHTML = "";
      for (const m of messages) {
        const author = m.author ?? m.autor ?? "anon";
        const type = m.type ?? m.tipo ?? "text";
        const item = document.createElement("div");
        item.className = "msg";
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `<span class="author">${author}</span><span class="time">${fmtTime(m.ts)}</span>`;
        const content = document.createElement("div");
        content.className = "content";
        if (type === "file" || type === "arquivo") {
          const a = document.createElement("a");
          a.className = "file-link";
          a.textContent = m.filename || m.nome || "arquivo";
          a.href = m.url || m.link || "#";
          a.target = "_blank";
          content.appendChild(a);
          const size = m.size ? ` • ${(m.size/1024).toFixed(1)} KB` : "";
          const meta2 = document.createElement("div");
          meta2.className = "hint";
          meta2.textContent = (m.mimetype || m.tipoMime || "") + size;
          content.appendChild(meta2);
        } else {
          content.textContent = m.text ?? m.texto ?? "";
        }
        item.appendChild(meta);
        item.appendChild(content);
        msgsEl.appendChild(item);
      }
      msgsEl.scrollTop = msgsEl.scrollHeight;
    }

    async function fetchMessages() {
      const roomId = roomEl.value || "geral";
      const r = await fetch(`${API}/rooms/${encodeURIComponent(roomId)}/messages`, { cache: "no-store" });
      const data = await r.json();
      render(data);
    }

    async function sendText(author, text) {
      const roomId = roomEl.value || "geral";
      const body = { author, text }; // backend também aceita autor/texto
      const r = await fetch(`${API}/rooms/${encodeURIComponent(roomId)}/messages`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!r.ok) throw new Error("Falha ao enviar mensagem");
      return r.json();
    }

    async function sendFile(author, file) {
      const roomId = roomEl.value || "geral";
      const fd = new FormData();
      fd.set("author", author);
      fd.set("file", file, file.name);
      const r = await fetch(`${API}/rooms/${encodeURIComponent(roomId)}/upload`, {
        method: "POST",
        body: fd
      });
      if (!r.ok) {
        const err = await r.text().catch(()=> "");
        throw new Error("Falha ao enviar arquivo: " + err);
      }
      return r.json();
    }

    // Envio: Enter envia, Shift+Enter quebra linha
    textEl.addEventListener("keydown", (ev) => {
      if (ev.key === "Enter" && !ev.shiftKey) {
        ev.preventDefault();
        formEl.requestSubmit();
      }
    });

    // Drag-and-drop de arquivo
    const composerBox = formEl;
    ["dragenter","dragover"].forEach(evt => composerBox.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation(); composerBox.style.outline = "2px dashed #5aa2ff";
    }));
    ;["dragleave","drop"].forEach(evt => composerBox.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation(); composerBox.style.outline = "none";
    }));
    composerBox.addEventListener("drop", async (e) => {
      const file = e.dataTransfer?.files?.[0];
      if (file) {
        await handleSend(null, file);
      }
    });

    async function handleSend(evt, droppedFile) {
      if (evt) evt.preventDefault();
      const author = (authorEl.value || "").trim() || "anon";
      const file = droppedFile || fileEl.files[0];
      const text = textEl.value;

      try {
        if (file) {
          await sendFile(author, file);
          fileEl.value = "";
        } else if (text.trim()) {
          await sendText(author, text);
          textEl.value = "";
        } else {
          return; // nada para enviar
        }
        await fetchMessages();
      } catch (e) {
        alert(e.message || "Erro ao enviar");
        console.error(e);
      }
    }

    formEl.addEventListener("submit", handleSend);
    refreshBtn.addEventListener("click", fetchMessages);

    // Polling leve (pode trocar por SSE depois)
    setInterval(fetchMessages, 3000);

    // Inicialização
    checkHealth();
    fetchMessages();
  </script>
</body>
</html>
